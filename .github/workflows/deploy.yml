name: Deploy to NCP

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 코드 체크아웃
      - name: Checkout
        uses: actions/checkout@v4

      # JDK 21 설치
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      # Gradle wrapper 실행 권한 부여
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Gradle로 프로젝트 빌드 (테스트 제외)
      - name: Build with Gradle (skip tests)
        run: ./gradlew clean build -x test

      # NCR(Naver Container Registry) 로그인
      - name: Login to NCR
        run: |
          echo ${{ secrets.NCR_ACCESS_KEY }} | docker login ${{ secrets.NCR_REGISTRY }} \
            -u ${{ secrets.NCR_ACCESS_KEY_ID }} \
            --password-stdin

      # Docker 이미지 빌드 및 NCR에 푸시
      - name: Build and Push Docker Image
        run: |
          SHA=${{ github.sha }}
          IMAGE_SHA_TAG=${{ secrets.NCR_REGISTRY }}/link-it-backend:${SHA}
          IMAGE_LATEST_TAG=${{ secrets.NCR_REGISTRY }}/link-it-backend:latest

          docker build -t $IMAGE_SHA_TAG .
          docker push $IMAGE_SHA_TAG

          docker tag $IMAGE_SHA_TAG $IMAGE_LATEST_TAG
          docker push $IMAGE_LATEST_TAG

      # 서버에서 Docker 컨테이너 배포
      - name: Deploy on NCP
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.NCP_HOST }}
          username: ${{ secrets.NCP_SSH_USER }}
          key: ${{ secrets.NCP_SSH_KEY }}
          command_timeout: 30m
          script: |
            cd /opt/link-it

            cat > .env << 'EOF'
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            REDIS_HOST=${{ secrets.REDIS_HOST }}
            REDIS_PORT=${{ secrets.REDIS_PORT }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
            NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
            NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_ACCESS_EXPIRATION=${{ secrets.JWT_ACCESS_EXPIRATION }}
            JWT_REFRESH_EXPIRATION=${{ secrets.JWT_REFRESH_EXPIRATION }}
            JWT_TEMP_EXPIRATION=${{ secrets.JWT_TEMP_EXPIRATION }}
            DEFAULT_PROFILE_IMAGE_URL: ${{ secrets.DEFAULT_PROFILE_IMAGE_URL }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            FRONTEND_PROD_URL=${{ secrets.FRONTEND_PROD_URL }}
            BACKEND_URL=${{ secrets.BACKEND_URL }}
            BACKEND_PROD_URL=${{ secrets.BACKEND_PROD_URL }}
            EOF

            echo ${{ secrets.NCR_ACCESS_KEY }} | docker login ${{ secrets.NCR_REGISTRY }} \
              -u ${{ secrets.NCR_ACCESS_KEY_ID }} \
              --password-stdin

            docker compose -f docker-compose.prod.yml down || true
            docker pull ${{ secrets.NCR_REGISTRY }}/link-it-backend:latest
            docker compose -f docker-compose.prod.yml up -d
            docker image prune -f